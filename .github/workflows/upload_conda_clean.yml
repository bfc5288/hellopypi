name: Upload to Anaconda, fresh

on:
  push:
    tags:
      - 'v*'

jobs:
  Upload:
    runs-on: ubuntu-latest
    container:
      image: continuumio/miniconda3


    steps:
    - uses: actions/checkout@v2
    - name: Install dependencies
      run: |
        conda install -y anaconda-client conda-build
        conda install -y setuptools setuptools_scm
    - name: Update recipe with version variable
      run: |
        #prepend version environment variable before writing files (preserves version of master)
        fpath="recipe/meta.yaml"
        v_str=$(python setup.py --version)
        line_str='{% set version = "v'${v_str}'" %}'
        echo $line_str | cat - $fpath > temp && mv temp $fpath
    - name: Build package and generate hash
      env:
        TEST_VAR: 'setup.py'
        TEST_VERSION: $(python setup.py --version)
        #below is more testing:
        #can't read source url from recipe, so generate it here:
        NAME: 'scimma-client'
        RECIPE_PATH: 'recipe/meta.yaml'
        VERSION: $(python setup.py --version)
        LINE_STR: '{% set version = "v'${VERSION}'" %}'
        SOURCE_URL: "https://pypi.io/packages/source/s/${NAME}/${NAME}-${VERSION}.tar.gz"

      run: |
        #build the package
        python3 $TEST_VAR sdist
        
        #use openssl to generate hash and yq to write updated hash to file
        wget https://github.com/mikefarah/yq/releases/download/3.1.0/yq_linux_amd64 -O yq
        chmod +x yq
        ./yq n source.sha256 $(openssl sha256 dist/*.tar.gz | awk '{print $2}') >> update.yaml

    - name: Apply updated hash
      run: |
        #render the recipe file with the generated hash
        conda render recipe/meta.yaml --append-file update.yaml

    - name: Build and upload
      env:
        CONDA_USERNAME: ${{ secrets.CONDA_USER }}
        CONDA_PASSWORD: ${{ secrets.CONDA_PW }}
      run: |
        conda config --set anaconda_upload yes
        anaconda login --username $CONDA_USERNAME --password $CONDA_PASSWORD
        conda build .
        anaconda logout
